<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n Modelo ML - Monitor CMG</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase for auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/auth.js"></script>

    <!-- Plotly for charts -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .threshold-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #10b981 0%, #3b82f6 50%, #ef4444 100%);
            outline: none;
        }

        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .threshold-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tooltip-trigger {
            position: relative;
            cursor: help;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .tooltip-trigger .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.3;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .tooltip-trigger .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }

        .tooltip-trigger:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.active {
            max-height: 1000px;
        }

        .confidence-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .confidence-high {
            background-color: #d1fae5;
            color: #065f46;
        }

        .confidence-medium {
            background-color: #fef3c7;
            color: #92400e;
        }

        .confidence-low {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen" style="visibility: hidden;">
    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo & Brand -->
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg border-2 border-amber-500 bg-white flex items-center justify-center shadow-sm">
                            <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="hidden sm:block">
                            <h1 class="text-lg font-bold text-gray-900 leading-tight">CMG Monitor</h1>
                            <p class="text-xs text-gray-500 leading-tight">Chilo√© - Tiempo Real</p>
                        </div>
                    </a>
                </div>

                <!-- Navigation Items -->
                <div class="flex items-center gap-1">
                    <!-- Dashboard -->
                    <a href="index.html"
                       class="px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 text-gray-700 hover:bg-blue-50 hover:text-gray-900">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.75">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span class="hidden lg:inline">Dashboard</span>
                    </a>

                    <!-- Optimizaci√≥n -->
                    <a href="optimizer.html"
                       class="px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 text-gray-700 hover:bg-emerald-50 hover:text-gray-900">
                        <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.75">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span class="hidden lg:inline">Optimizar</span>
                    </a>

                    <!-- ML Config (Active) -->
                    <a href="ml_config.html"
                       class="px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 bg-gradient-to-r from-blue-500 to-cyan-600 text-white shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.75">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span class="hidden lg:inline">ML Config</span>
                    </a>

                    <!-- Pron√≥sticos -->
                    <a href="forecast_comparison.html"
                       class="px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 text-gray-700 hover:bg-purple-50 hover:text-gray-900">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.75">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        <span class="hidden lg:inline">Pron√≥sticos</span>
                    </a>

                    <!-- Rendimiento -->
                    <a href="rendimiento.html"
                       class="px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 text-gray-700 hover:bg-amber-50 hover:text-gray-900">
                        <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.75">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                        </svg>
                        <span class="hidden lg:inline">Rendimiento</span>
                    </a>

                    <!-- Separator -->
                    <div class="h-6 w-px bg-gray-200 mx-2"></div>

                    <!-- User Menu -->
                    <div class="relative" id="user-menu-container"
                         onmouseenter="document.getElementById('user-menu-dropdown').classList.remove('hidden')"
                         onmouseleave="document.getElementById('user-menu-dropdown').classList.add('hidden')">
                        <button class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-gray-700 hover:bg-gray-100">
                            <div id="user-avatar" class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center text-white text-xs font-medium shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.75">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <span id="user-email-display" class="hidden sm:inline max-w-[120px] truncate">Usuario</span>
                            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.75">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="user-menu-dropdown" class="hidden absolute right-0 top-full pt-1 w-52 z-50">
                            <div class="bg-white rounded-xl shadow-lg border border-gray-200 py-2 overflow-hidden">
                                <div class="px-4 py-2 border-b border-gray-100">
                                    <p class="text-xs text-gray-500">Conectado como</p>
                                    <p id="user-email-full" class="text-sm font-medium text-gray-900 truncate">usuario@email.com</p>
                                </div>
                                <button onclick="showPasswordChangeModal()"
                                        class="w-full px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition-all duration-200">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.75">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                    </svg>
                                    Cambiar Contrasena
                                </button>
                                <div class="h-px bg-gray-100 my-1"></div>
                                <button onclick="logout()"
                                        class="w-full px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3 transition-all duration-200">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.75">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Cerrar Sesion
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Loading State -->
    <div id="loading-container" class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex flex-col items-center justify-center">
                <div class="loading-spinner mb-4"></div>
                <h2 class="text-xl font-semibold text-gray-700 mb-2">
                    Cargando configuraci√≥n ML...
                </h2>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="container mx-auto px-4 py-8 hidden">

        <!-- Model Information Card -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Informaci√≥n del Modelo</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h3 class="text-sm font-medium text-gray-500 mb-1">Versi√≥n del Modelo</h3>
                    <p id="model-version" class="text-xl font-bold text-blue-600">--</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-500 mb-1">√öltima Actualizaci√≥n</h3>
                    <p id="last-update" class="text-xl font-bold text-green-600">--</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-500 mb-1">Horizonte de Predicci√≥n</h3>
                    <p id="prediction-horizon" class="text-xl font-bold text-purple-600">24 horas</p>
                </div>
            </div>

            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-blue-900 mb-2">‚ÑπÔ∏è Acerca del Modelo</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>‚Ä¢ <strong>144 modelos ML</strong>: 48 de detecci√≥n de ceros + 96 de predicci√≥n de valores</li>
                    <li>‚Ä¢ <strong>Arquitectura de 2 etapas</strong>: Etapa 1 predice ceros, Etapa 2 predice valores</li>
                    <li>‚Ä¢ <strong>Ensamble</strong>: LightGBM + XGBoost con regresi√≥n cuant√≠lica</li>
                    <li>‚Ä¢ <strong>Umbrales √≥ptimos</strong>: Maximizados por F1 y optimizados por ganancia para cada horizonte</li>
                </ul>
            </div>
        </div>

        <!-- Current Forecast - NEW! -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üîÆ Pron√≥stico Actual (24 horas)</h2>
                <div id="uncertainty-summary" class="text-sm font-semibold">
                    <!-- Will be populated with uncertainty count -->
                </div>
            </div>

            <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h3 class="font-semibold text-blue-900 mb-2">üìñ C√≥mo Leer Esta Tabla</h3>
                <div class="text-sm text-blue-800 space-y-1">
                    <p>‚Ä¢ <strong>Probabilidad de CMG=0</strong>: Confianza del modelo en que el CMG ser√° cero (0-100%)</p>
                    <p>‚Ä¢ <strong>Umbral √ìptimo</strong>: Punto de corte para decidir si predecir cero o valor</p>
                    <p>‚Ä¢ <strong>Confianza</strong>:</p>
                    <ul class="ml-6 mt-1">
                        <li><span class="confidence-badge confidence-high">Alta</span> - Predicci√≥n muy segura (lejos del umbral)</li>
                        <li><span class="confidence-badge confidence-medium">Media</span> - Predicci√≥n moderada (cercana al umbral ¬±10%)</li>
                        <li><span class="confidence-badge confidence-low">Baja</span> - Predicci√≥n incierta (muy cerca del umbral ¬±5%)</li>
                    </ul>
                </div>
            </div>

            <!-- Forecast Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b-2 border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Hora</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Horizonte</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Predicci√≥n CMG</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Prob. CMG=0</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Umbral</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-700">Confianza</th>
                        </tr>
                    </thead>
                    <tbody id="forecast-table-body" class="divide-y divide-gray-200">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reliability Analysis Chart - REPLACED static performance chart -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìà An√°lisis de Confiabilidad del Pron√≥stico</h2>

            <div class="mb-4 p-4 bg-green-50 rounded-lg border border-green-200">
                <h3 class="font-semibold text-green-900 mb-2">üí° ¬øQu√© Muestra Este Gr√°fico?</h3>
                <p class="text-sm text-green-800">
                    Este gr√°fico muestra la <strong>probabilidad de CMG=0</strong> (puntos azules) vs el <strong>umbral √≥ptimo</strong> (l√≠nea roja)
                    para cada horizonte. Los puntos alejados del umbral indican predicciones m√°s confiables.
                    Los puntos cerca del umbral (¬±10%) son predicciones inciertas.
                </p>
            </div>

            <div id="reliability-chart" style="height: 400px;"></div>
        </div>

        <!-- Decision Thresholds -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üéØ Umbrales de Decisi√≥n</h2>
                <div class="text-sm text-gray-600">
                    <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-1"></span> Bajo Riesgo
                    <span class="inline-block w-3 h-3 bg-blue-500 rounded-full ml-3 mr-1"></span> √ìptimo
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full ml-3 mr-1"></span> Alto Riesgo
                </div>
            </div>

            <div class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <h3 class="font-semibold text-yellow-900 mb-2">‚ö†Ô∏è Acerca de los Umbrales</h3>
                <p class="text-sm text-yellow-800">
                    Los umbrales de decisi√≥n determinan cu√°ndo el modelo predice CMG = $0. Umbrales m√°s bajos ‚Üí m√°s predicciones de cero (conservador).
                    Umbrales m√°s altos ‚Üí menos predicciones de cero (agresivo). Los umbrales actuales est√°n <strong>optimizados por ganancia</strong> y son
                    <strong>solo lectura</strong> para mantener la precisi√≥n del modelo.
                </p>
                <p class="text-sm text-yellow-800 mt-2">
                    <strong>Nota:</strong> Estos valores provienen de la validaci√≥n del modelo en datos hist√≥ricos que el modelo nunca vio durante el entrenamiento.
                </p>
            </div>

            <!-- Thresholds Grid -->
            <div id="thresholds-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Thresholds will be populated here -->
            </div>
        </div>

        <!-- Metrics Explanation - NEW! -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center cursor-pointer" onclick="toggleMetricsExplanation()">
                <h2 class="text-2xl font-bold text-gray-800">üí° Interpretaci√≥n de M√©tricas</h2>
                <svg id="metrics-toggle-icon" class="w-6 h-6 text-gray-600 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>

            <div id="metrics-explanation" class="collapsible-content active mt-4">
                <div class="space-y-6">
                    <!-- Precision -->
                    <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                        <h3 class="font-bold text-green-900 mb-2 flex items-center">
                            <span class="text-2xl mr-2">üéØ</span> Precisi√≥n (Precision)
                        </h3>
                        <p class="text-sm text-green-800 mb-2">
                            <strong>Definici√≥n:</strong> De todas las veces que el modelo predijo CMG > $0, ¬øen cu√°ntas acert√≥?
                        </p>
                        <div class="bg-white p-3 rounded border border-green-300">
                            <p class="text-sm text-gray-700 font-mono">
                                Precisi√≥n = (CMG > 0 correctos) / (Todas las predicciones CMG > 0)
                            </p>
                        </div>
                        <p class="text-sm text-green-800 mt-2">
                            <strong>Ejemplo:</strong> Si Precisi√≥n = 60%, significa que de 100 veces que predijo CMG > $0, acert√≥ en 60 ocasiones.
                            Las otras 40 fueron "falsas alarmas" (predijo valor pero fue cero).
                        </p>
                    </div>

                    <!-- Recall -->
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="font-bold text-blue-900 mb-2 flex items-center">
                            <span class="text-2xl mr-2">üîç</span> Exhaustividad (Recall)
                        </h3>
                        <p class="text-sm text-blue-800 mb-2">
                            <strong>Definici√≥n:</strong> De todas las horas que realmente tuvieron CMG > $0, ¬øcu√°ntas detect√≥ el modelo?
                        </p>
                        <div class="bg-white p-3 rounded border border-blue-300">
                            <p class="text-sm text-gray-700 font-mono">
                                Recall = (CMG > 0 detectados) / (Todos los CMG > 0 reales)
                            </p>
                        </div>
                        <p class="text-sm text-blue-800 mt-2">
                            <strong>Ejemplo:</strong> Si Recall = 75%, significa que de 100 horas con CMG > $0, el modelo detect√≥ 75.
                            Las otras 25 fueron "oportunidades perdidas" (predijo cero pero fue valor).
                        </p>
                    </div>

                    <!-- F1 Score -->
                    <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-purple-900 mb-2 flex items-center">
                            <span class="text-2xl mr-2">‚öñÔ∏è</span> Puntuaci√≥n F1 (F1 Score)
                        </h3>
                        <p class="text-sm text-purple-800 mb-2">
                            <strong>Definici√≥n:</strong> Promedio arm√≥nico entre Precisi√≥n y Recall. Equilibra ambas m√©tricas.
                        </p>
                        <div class="bg-white p-3 rounded border border-purple-300">
                            <p class="text-sm text-gray-700 font-mono">
                                F1 = 2 √ó (Precisi√≥n √ó Recall) / (Precisi√≥n + Recall)
                            </p>
                        </div>
                        <p class="text-sm text-purple-800 mt-2">
                            <strong>Ejemplo:</strong> Si F1 = 67%, el modelo tiene un buen balance entre no generar falsas alarmas (precisi√≥n)
                            y no perder oportunidades (recall). Valores m√°s altos indican mejor rendimiento general.
                        </p>
                    </div>

                    <!-- How calculated -->
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                            <span class="text-2xl mr-2">üß™</span> ¬øC√≥mo se Calcularon Estas M√©tricas?
                        </h3>
                        <p class="text-sm text-gray-700">
                            Durante el entrenamiento del modelo, se separ√≥ un conjunto de datos de <strong>validaci√≥n</strong> (datos hist√≥ricos
                            que el modelo nunca vio). El modelo hizo predicciones sobre estos datos y comparamos con los valores reales:
                        </p>
                        <ul class="text-sm text-gray-700 mt-2 space-y-1 ml-4">
                            <li>‚Ä¢ <strong>Aciertos:</strong> Modelo predijo CMG > 0 Y fue CMG > 0 ‚úÖ</li>
                            <li>‚Ä¢ <strong>Falsas Alarmas:</strong> Modelo predijo CMG > 0 PERO fue CMG = 0 ‚ùå</li>
                            <li>‚Ä¢ <strong>Oportunidades Perdidas:</strong> Modelo predijo CMG = 0 PERO fue CMG > 0 ‚ö†Ô∏è</li>
                            <li>‚Ä¢ <strong>Rechazos Correctos:</strong> Modelo predijo CMG = 0 Y fue CMG = 0 ‚úÖ</li>
                        </ul>
                    </div>

                    <!-- Why they matter -->
                    <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <h3 class="font-bold text-orange-900 mb-2 flex items-center">
                            <span class="text-2xl mr-2">üéì</span> ¬øPor Qu√© Importan?
                        </h3>
                        <p class="text-sm text-orange-800">
                            Estas m√©tricas te ayudan a entender la <strong>confiabilidad</strong> del modelo:
                        </p>
                        <ul class="text-sm text-orange-800 mt-2 space-y-1 ml-4">
                            <li>‚Ä¢ <strong>Precisi√≥n alta</strong> ‚Üí Pocas falsas alarmas, puedes confiar en predicciones CMG > 0</li>
                            <li>‚Ä¢ <strong>Recall alto</strong> ‚Üí Pocas oportunidades perdidas, detecta la mayor√≠a de casos CMG > 0</li>
                            <li>‚Ä¢ <strong>F1 alto</strong> ‚Üí Buen balance general, modelo confiable</li>
                        </ul>
                        <p class="text-sm text-orange-800 mt-2">
                            <strong>Nota:</strong> Los valores var√≠an por horizonte porque predecir 1 hora adelante es m√°s f√°cil que 24 horas adelante.
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let thresholdsData = null;
        let mlPredictionsData = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // Require authentication before loading content
            const session = await requireAuth();
            if (!session) return; // Will redirect to login

            // Display user email
            if (session.user && session.user.email) {
                const emailDisplay = document.getElementById('user-email-display');
                if (emailDisplay) {
                    emailDisplay.textContent = session.user.email;
                }
            }

            // Close user menu when clicking outside
            document.addEventListener('click', function(event) {
                const container = document.getElementById('user-menu-container');
                const dropdown = document.getElementById('user-menu-dropdown');
                if (container && dropdown && !container.contains(event.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            initializeApp();
        });

        async function initializeApp() {
            try {
                // Fetch thresholds
                const thresholdsResponse = await fetch('/api/ml_thresholds');
                const thresholdsJson = await thresholdsResponse.json();

                if (thresholdsJson.success) {
                    thresholdsData = thresholdsJson;

                    // Also fetch ML predictions for model info and live forecast
                    try {
                        const predictionsResponse = await fetch('/api/ml_forecast');
                        const predictionsJson = await predictionsResponse.json();
                        if (predictionsJson.success) {
                            mlPredictionsData = predictionsJson;
                        }
                    } catch (e) {
                        console.warn('No se pudieron cargar las predicciones:', e);
                    }

                    // Update UI
                    updateModelInfo();
                    renderCurrentForecast();
                    renderReliabilityChart();
                    renderThresholds();

                    // Hide loading, show content
                    document.getElementById('loading-container').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                } else {
                    throw new Error('Error al cargar umbrales');
                }
            } catch (error) {
                console.error('Error al inicializar:', error);
                document.getElementById('loading-container').innerHTML =
                    '<div class="text-center text-red-600">Error al cargar la configuraci√≥n ML. Por favor, intenta de nuevo.</div>';
            }
        }

        function updateModelInfo() {
            if (mlPredictionsData) {
                document.getElementById('model-version').textContent = mlPredictionsData.model_version || 'v1.0';

                // Use forecast_time or status.last_update (API changed from generated_at)
                const lastUpdate = mlPredictionsData.forecast_time || mlPredictionsData.status?.last_update || mlPredictionsData.generated_at;
                document.getElementById('last-update').textContent = lastUpdate
                    ? new Date(lastUpdate).toLocaleString('es-CL', {
                        day: '2-digit',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                    : '--';
            }
        }

        function renderCurrentForecast() {
            if (!mlPredictionsData || !mlPredictionsData.predictions) {
                return;
            }

            const tbody = document.getElementById('forecast-table-body');
            tbody.innerHTML = '';

            let uncertainCount = 0;

            mlPredictionsData.predictions.forEach(pred => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // Calculate confidence
                const zeroProbPercent = pred.zero_probability * 100;
                const thresholdPercent = pred.decision_threshold * 100;
                const distance = Math.abs(zeroProbPercent - thresholdPercent);

                let confidenceBadge, confidenceClass;
                if (distance > 10) {
                    confidenceBadge = 'Alta';
                    confidenceClass = 'confidence-high';
                } else if (distance > 5) {
                    confidenceBadge = 'Media';
                    confidenceClass = 'confidence-medium';
                    uncertainCount++;
                } else {
                    confidenceBadge = 'Baja';
                    confidenceClass = 'confidence-low';
                    uncertainCount++;
                }

                const cmgValue = pred.predicted_cmg || pred.cmg_predicted || 0;
                const cmgDisplay = cmgValue === 0
                    ? '<span class="text-gray-600 font-semibold">$0.00</span>'
                    : `<span class="text-green-600 font-semibold">$${cmgValue.toFixed(2)}</span>`;

                row.innerHTML = `
                    <td class="px-4 py-3 text-gray-700">${new Date(pred.datetime).toLocaleString('es-CL', {
                        day: '2-digit',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</td>
                    <td class="px-4 py-3 text-gray-600">t+${pred.horizon}</td>
                    <td class="px-4 py-3 text-right">${cmgDisplay}</td>
                    <td class="px-4 py-3 text-right text-blue-700 font-medium">${zeroProbPercent.toFixed(1)}%</td>
                    <td class="px-4 py-3 text-right text-gray-600">${thresholdPercent.toFixed(1)}%</td>
                    <td class="px-4 py-3 text-center">
                        <span class="confidence-badge ${confidenceClass}">${confidenceBadge}</span>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // Update uncertainty summary
            const summary = document.getElementById('uncertainty-summary');
            if (uncertainCount > 0) {
                summary.innerHTML = `
                    <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full">
                        ‚ö†Ô∏è ${uncertainCount} predicciones inciertas
                    </span>
                `;
            } else {
                summary.innerHTML = `
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full">
                        ‚úÖ Todas las predicciones confiables
                    </span>
                `;
            }
        }

        function renderReliabilityChart() {
            if (!mlPredictionsData || !mlPredictionsData.predictions) {
                return;
            }

            const predictions = mlPredictionsData.predictions;

            // Scatter plot: zero probability vs threshold
            const scatterTrace = {
                x: predictions.map(p => p.horizon),
                y: predictions.map(p => p.zero_probability * 100),
                name: 'Probabilidad CMG=0',
                type: 'scatter',
                mode: 'markers',
                marker: {
                    size: 10,
                    color: predictions.map(p => {
                        const distance = Math.abs(p.zero_probability * 100 - p.decision_threshold * 100);
                        if (distance > 10) return '#10b981'; // green - high confidence
                        if (distance > 5) return '#f59e0b';  // yellow - medium
                        return '#ef4444'; // red - low confidence
                    }),
                    line: {
                        color: '#1f2937',
                        width: 1
                    }
                },
                text: predictions.map(p => {
                    const distance = Math.abs(p.zero_probability * 100 - p.decision_threshold * 100);
                    return `Horizonte ${p.horizon}<br>` +
                           `Prob CMG=0: ${(p.zero_probability * 100).toFixed(1)}%<br>` +
                           `Umbral: ${(p.decision_threshold * 100).toFixed(1)}%<br>` +
                           `Distancia: ${distance.toFixed(1)}%`;
                }),
                hovertemplate: '%{text}<extra></extra>'
            };

            // Line plot: thresholds
            const thresholdTrace = {
                x: predictions.map(p => p.horizon),
                y: predictions.map(p => p.decision_threshold * 100),
                name: 'Umbral √ìptimo',
                type: 'scatter',
                mode: 'lines',
                line: {
                    color: '#ef4444',
                    width: 2,
                    dash: 'dash'
                }
            };

            const layout = {
                xaxis: {
                    title: 'Horizonte de Pron√≥stico (horas)',
                    dtick: 1
                },
                yaxis: {
                    title: 'Probabilidad (%)',
                    range: [0, 100]
                },
                showlegend: true,
                legend: { x: 0.02, y: 0.98 },
                hovermode: 'closest',
                margin: { t: 20, r: 20, b: 60, l: 60 },
                shapes: [
                    // Uncertainty band ¬±10% around threshold
                    {
                        type: 'rect',
                        xref: 'paper',
                        x0: 0,
                        x1: 1,
                        yref: 'y',
                        y0: 0,
                        y1: 100,
                        fillcolor: '#fee2e2',
                        opacity: 0.1,
                        layer: 'below',
                        line: { width: 0 }
                    }
                ]
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            };

            Plotly.newPlot('reliability-chart', [thresholdTrace, scatterTrace], layout, config);
        }

        function renderThresholds() {
            const grid = document.getElementById('thresholds-grid');
            grid.innerHTML = '';

            thresholdsData.thresholds.forEach((threshold, index) => {
                const card = document.createElement('div');
                card.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-lg transition-shadow';

                const optimalPercent = (threshold.optimal_threshold * 100).toFixed(1);
                const minPercent = (threshold.min_allowed * 100).toFixed(1);
                const maxPercent = (threshold.max_allowed * 100).toFixed(1);

                // Display as forecast horizon (t+1 to t+24)
                const horizonLabel = `t+${index + 1}`;

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold text-gray-800">${horizonLabel}</h3>
                        <span class="text-2xl font-bold text-blue-600">${optimalPercent}%</span>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>M√≠n: ${minPercent}%</span>
                                <span>M√°x: ${maxPercent}%</span>
                            </div>
                            <div class="relative">
                                <div class="threshold-slider" style="background: linear-gradient(to right, #10b981 0%, #3b82f6 50%, #ef4444 100%);"></div>
                                <div class="absolute" style="left: ${optimalPercent}%; top: -4px; width: 3px; height: 14px; background: #1e40af; border-radius: 2px;"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="text-center p-2 bg-green-50 rounded">
                                <div class="font-semibold text-green-700">
                                    <span class="tooltip-trigger">
                                        Precisi√≥n
                                        <span class="tooltip-text">De todas las predicciones CMG > 0, cu√°ntas fueron correctas</span>
                                    </span>
                                </div>
                                <div class="text-green-900">${(threshold.precision * 100).toFixed(1)}%</div>
                            </div>
                            <div class="text-center p-2 bg-blue-50 rounded">
                                <div class="font-semibold text-blue-700">
                                    <span class="tooltip-trigger">
                                        Recall
                                        <span class="tooltip-text">De todos los CMG > 0 reales, cu√°ntos detect√≥ el modelo</span>
                                    </span>
                                </div>
                                <div class="text-blue-900">${(threshold.recall * 100).toFixed(1)}%</div>
                            </div>
                            <div class="text-center p-2 bg-purple-50 rounded">
                                <div class="font-semibold text-purple-700">
                                    <span class="tooltip-trigger">
                                        F1
                                        <span class="tooltip-text">Balance entre Precisi√≥n y Recall</span>
                                    </span>
                                </div>
                                <div class="text-purple-900">${(threshold.f1 * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function toggleMetricsExplanation() {
            const content = document.getElementById('metrics-explanation');
            const icon = document.getElementById('metrics-toggle-icon');

            content.classList.toggle('active');
            icon.classList.toggle('rotate-180');
        }
    </script>
</body>
</html>
